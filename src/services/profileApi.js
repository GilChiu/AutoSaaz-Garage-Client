/**
 * AutoSaaz Profile API Service
 * Handles user profile management and password operations
 */

import { FUNCTIONS_URL, SUPABASE_ANON_KEY } from '../config/supabase';
const API_BASE_URL = process.env.REACT_APP_FUNCTIONS_URL || FUNCTIONS_URL;

function headers() {
  const accessToken = localStorage.getItem('accessToken') || localStorage.getItem('token');
  return {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
    ...(accessToken ? { 'x-autosaaz-token': accessToken } : {}),
  };
}

/**
 * Get user profile with additional details
 */
export const getUserProfile = async () => {
  try {
    console.log('=== GET USER PROFILE START ===');
    
    const response = await fetch(`${API_BASE_URL}/auth-profile`, {
      method: 'GET',
      headers: headers(),
    });

    console.log('Profile Response Status:', response.status);
    console.log('Profile Response OK:', response.ok);

    const data = await response.json();
    console.log('Profile Response Data:', data);

    if (!response.ok) {
      throw new Error(data.message || 'Failed to fetch profile');
    }

    console.log('=== GET USER PROFILE SUCCESS ===');
    return data;
  } catch (error) {
    console.error('=== GET USER PROFILE ERROR ===');
    console.error('Error Type:', error.name);
    console.error('Error Message:', error.message);
    console.error('Error Stack:', error.stack);
    throw error;
  }
};

/**
 * Get user password
 */
export const getUserPassword = async () => {
  try {
    console.log('=== GET USER PASSWORD START ===');
    
    // No real password endpoint on Supabase; return generated or default
    const generated = localStorage.getItem('userGeneratedPassword');
    return { success: true, data: { password: generated || '********' }, message: 'Password placeholder' };
  } catch (error) {
    console.error('=== GET USER PASSWORD ERROR ===');
    console.error('Error Type:', error.name);
    console.error('Error Message:', error.message);
    console.error('Error Stack:', error.stack);
    
    // Return default password instead of throwing error
    console.log('Returning default password due to error');
    return {
      success: true,
      data: { password: 'AutoSaaz2024!' },
      message: 'Default password returned due to error'
    };
  }
};

/**
 * Update user profile
 */
export const updateUserProfile = async (profileData) => {
  try {
    console.log('=== UPDATE USER PROFILE START ===');
    console.log('Profile Data:', profileData);
    
    const response = await fetch(`${API_BASE_URL}/auth-profile`, {
      method: 'PUT',
      headers: headers(),
      body: JSON.stringify(profileData),
    });

    console.log('Update Response Status:', response.status);
    console.log('Update Response OK:', response.ok);

    const data = await response.json();
    console.log('Update Response Data:', data);

    if (!response.ok) {
      throw new Error(data.message || 'Failed to update profile');
    }

    console.log('=== UPDATE USER PROFILE SUCCESS ===');
    return data;
  } catch (error) {
    console.error('=== UPDATE USER PROFILE ERROR ===');
    console.error('Error Type:', error.name);
    console.error('Error Message:', error.message);
    console.error('Error Stack:', error.stack);
    throw error;
  }
};

/**
 * Change password
 */
export const changePassword = async (newPassword) => {
  try {
    console.log('=== CHANGE PASSWORD START ===');
    
    const response = await fetch(`${API_BASE_URL}/auth-profile`, {
      method: 'PUT',
      headers: headers(),
      body: JSON.stringify({ password: newPassword }),
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok) throw new Error(data.message || 'Failed to change password');
    return data;
  } catch (error) {
    console.error('=== CHANGE PASSWORD ERROR ===');
    console.error('Error Type:', error.name);
    console.error('Error Message:', error.message);
    console.error('Error Stack:', error.stack);
    throw error;
  }
};